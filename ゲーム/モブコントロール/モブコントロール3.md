以下を参考に3Dゲームを作成する。
一通りの知識を学べる。

## 【自分の記事まとめ】ゲームエンジンGodot4.0でスマホ3Dゲームを作ってみる
https://qiita.com/FootInGlow/items/5754cee8f4c691cbc170

---

## 【Godot 4.0】スマホ3Dゲームを作るための勉強　その９　敵を検知するとホーミングするようにしたい
https://qiita.com/FootInGlow/items/5b1c78669e2d56d98f1b

### 敵（円柱）を配置する

円柱にぶつかっても表面を滑って弾が通り過ぎてゆく。
![[Pasted image 20250205013640.png]]
### Collisionレイヤーを定義する

衝突・検知のノードのグループを定義する。
プロジェクトメニューのプロジェクト設定でLayer Names/3D物理を開き、レイヤーを設定。

![[Pasted image 20250205013900.png]]


各ノードにレイヤーを設定する。

| Layerに設定するもの      | Maskに設定するもの（衝突・検出したいもの）                                             |
| ----------------- | ------------------------------------------------------------------- |
| FloorAndObstacles | なし（検出されるが、自ら衝突/検出したいということはない）                                       |
| Player            | FloorAndObstacles（そのうち左右に壁を作って移動制限をしたい）                             |
| Enemy             | なし（今のところ移動予定はない）                                                    |
| Bullet            | FloorAndObstacles、Enemy、Bulletに衝突してほしいが検出はしない（Bullet同士も重ならないようにしたい） |
|                   |                                                                     |
以下のように、シーンで対象のノードを選択して、インスペクタで設定。
![[Pasted image 20250205014333.png]]

| Node              | Layer（自分の属性）        | Mask（衝突を検知したい対象）                     |
| ----------------- | ------------------- | ------------------------------------ |
| FloorAndObstacles | 1：FloorAndObstacles | なし                                   |
| Player            | 2：Player            | 1：FloorAndObstacles                  |
| Enemy             | 3：Enemy             | なし                                   |
| Bullet            | 4：Bullet            | 1：FloorAndObstacles、3：Enemy、4：Bullet |
|                   |                     |                                      |

ある程度近づいたら敵に向かうようにしたい。
### Enemyに円を設定する

敵にArea3Dを設定。形は球体とし、Enemyを包むように。

![[Pasted image 20250205015535.png]]
![[Pasted image 20250205015726.png]]

![[Pasted image 20250205015853.png]]


| Node              | Layer（自分の属性）        | Mask（衝突を検知したい対象）                     |
| ----------------- | ------------------- | ------------------------------------ |
| FloorAndObstacles | 1：FloorAndObstacles | なし                                   |
| Player            | 2：Player            | 1：FloorAndObstacles                  |
| Enemy             | 3：Enemy             | なし                                   |
| Bullet            | 4：Bullet            | 1：FloorAndObstacles、3：Enemy、4：Bullet |
| BulletSensor      | なし                  | 4：Bullet                             |

Enemyにスクリプトをアタッチし、BulletSensorからシグナルを設定。`PhysicsBody3D`ノードを検出したいので、`body_entered(body:Node3D)`を右クリックして接続。接続先はEnemyのスクリプト。

![[Pasted image 20250205020126.png]]

![[Pasted image 20250205020246.png]]
CharacterBody3DやRigidBody3Dなど検出したい場合は、body_xxx シグナル。
Area3Dを検出したい場合は、area_xxx シグナルを使用する。

Enemyスクリプト
```python
extends CharacterBody3D

func _on_bullet_sensor_body_entered(body):
	print(body)
```

BulletがBulletSensorの円の中にはいると、コンソールにノード名（Bullet）がprintされるのが分かる。

![[Pasted image 20250205021340.png]]

### Enemyの位置をBulletに通知する

Enemyスクリプト
```python
extends CharacterBody3D

func _on_bullet_sensor_body_entered(body):
	body.discover_enemy(transform.origin)
```

Bulletスクリプト
```python
extends CharacterBody3D

@export var m_v_dir = Vector3(0.0, 0.0, -1.0)
@export var m_d_speed_mps = 2.0

var m_v3_enemy_pos = null

func discover_enemy(enemy_pos):
	m_v3_enemy_pos = enemy_pos

func _physics_process(delta):
	if m_v3_enemy_pos:
		m_v_dir = m_v3_enemy_pos - transform.origin
	else:
		m_v_dir = Vector3.FORWARD
	velocity = m_v_dir.normalized() * m_d_speed_mps
	move_and_slide()

func _on_visible_on_screen_notifier_3d_screen_exited() -> void:
	queue_free()

```

メンバ変数初期値のVector3(0, 0, -1)をVector3.FORWARDに修正
- @export var m_v_dir = Vector3.FORWARD
	Vector3に定義されている定数に変更。値としてはVector3(0, 0, -1)なので同じ。

func _physics_process(delta):の修正
- if m_v3_enemy_pos:  
    　m_v3_enemy_posが設定されている場合
- m_v_dir = m_v3_enemy_pos - transform.origin  
    　目標位置から現在位置を引くと、現在位置から目標位置へ向かう方向になる
- else:  
    　m_v3_enemy_posが設定されていない場合
- m_v_dir = Vector3.FORWARD  
    　今まで通り前進する（Z軸マイナス方向）

BulletがEnemyに近づくと、Enemyに向きを変えて、最終的にくっつくようになった。
![[Pasted image 20250205022734.png]]

---
## 【Godot 4.0】スマホ3Dゲームを作るための勉強　その１０　敵を増やす、Bullet vs Enemyの処理を実装
https://qiita.com/FootInGlow/items/5b1c78669e2d56d98f1b


