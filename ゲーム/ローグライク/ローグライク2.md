以下サイトを参考にゲームを作る。本当に超絶参考になる。

ローグライクを作ったので開発手順をまとめてみた - Qiita
https://qiita.com/2dgames_jp/items/1730e7c4822091c3c320

---
## Step 4. The Map (マップとマップオブジェクト)

TileMapから自動生成するのではなく、GridMapを手作りする。

### KENNEY：無料素材
https://kenney.nl/assets

KENNEYの素材とかひとまず使ってみるかな。
素材をダウンロードしたが対応しているファイル形式が色々ある。

![[Pasted image 20250214032007.png]]
[[ファイル形式]]について調べてみたが、GLB（glTF）ファイルがいいっぽい。

![[Pasted image 20250214033633.png]]
### GridMapの使用
https://docs.godotengine.org/ja/4.x/tutorials/3d/using_gridmaps.html

3Dモデルのファイルからシーンを作成。
実際、この作り方をする必要はない。
RootにNode3Dか何かのノードをぶら下げて、その下に3Dモデルを配置。
最後に、ブランチをシーンとして保存すれば同じこと。
![[Pasted image 20250215022653.png]]

![[Pasted image 20250215022857.png]]
該当のシーンを選んだ状態でエクスポート > メッシュライブラリを選択。
既存のMeshLibraryを選んで追加するか、新しいMeshLibraryを作成するかする。
![[Pasted image 20250215023011.png]]
GridMapにどのMeshLibraryを使うか指定する。
１つのGridMapで１種類のMeshLibraryしか使えない。
![[Pasted image 20250215023543.png]]
Libraryからスタンプみたいにペタペタ貼り付けてマップを作成。
左クリックで作成。右クリックで削除。
![[Pasted image 20250215123139.png]]
ただ…、MeshLibraryで参照するシーンに設定したCollisionShape3Dとの衝突検知ができない…。何故？？
以下の記事を見る限り、Libraryに設定したCollisionShape3Dも有効なはずだが…。

### Godot4でBlenderファイルからMeshLibraryを作成して、GridMapを使ってみた
https://qiita.com/FootInGlow/items/48710c1798e41d4cc008

どうやらノードの順番が問題らしい。（なんだそれ）

### GridMapが衝突を検知しない（英語）
https://www.reddit.com/r/godot/comments/15dbt0b/gridmaps_are_not_allowing_collisions/

私も同じ問題に遭遇しました。私の場合、MeshLibraryを構築していたシーンが正しく設定されていませんでした。

各タイルのオブジェクト階層は次のようになりました。

- StaticBody3D
    - MeshInstance3D
    - CollisionShape3D

うまくいったのは、階層を次のように並べ替えることです。

- MeshInstance3D
    - StaticBody3D
        - CollisionShape3D

GridMapの変更を反映するには、必ず再エクスポート/再インポートを実行してください。お役に立てれば幸いです。

んー、上記のようにしたけど上手くいなかない。
ちゃんとCollisionShape3Dは機能しているし、RayCastもちゃんと触れている。
Layersも設定している。なのに何故機能しない。

![[Pasted image 20250215125144.png]]

RayCastのCollideWithのBodiesをONにしないと、StaticBody3Dに設定したCollisionShape3Dを検知しないらしい。
ちなみに、RayCastのCollideWithのAreasがONなら、Area3Dに設定したCollisionShape3Dを検知する。

![[Pasted image 20250215130203.png]]

あー、原因が分かった。
以下のスクリプトでCollisionShape3Dの座標ではなく、GridMapの座標を取得しているから。

```python
func get_direction(direction):
	if not direction is RayCast3D: return
	return direction.get_collider().global_transform.origin - global_transform.origin
```

んー、これどう取得したらいいんだ？

### グリッドマップ衝突検出 ＃25475
https://github.com/godotengine/godot/issues/25475

こんな感じでGripMap上の座標を検出しないと駄目みたい。（面倒臭い）

```python
func _ready():
	connect("body_entered", self, "collided")

func collided(body):	
	if body is GridMap:
		#print("collided with: ", body)
		var grid = body
		var pos =  self.global_transform.origin - grid.translation
		var gridPos = grid.world_to_map( pos )
		var item = grid.get_cell_item(gridPos.x, gridPos.y, gridPos.z)
		if item != GridMap.INVALID_CELL_ITEM :
			print("gridPos ", gridPos, "item: ", item )
                        # so some logic here
```


以下は参考にならなそう。
```python
extends Node
var mouse_pick_ray_length = 1000

# cast a ray from camera at mouse position, and get the object colliding with the ray
func mouse_pick():
	var camera = get_viewport().get_camera()
	var mouse_pos = get_viewport().get_mouse_position()
	var ray_from = camera.project_ray_origin(mouse_pos)
	var ray_to = ray_from + camera.project_ray_normal(mouse_pos) * mouse_pick_ray_length
	var space_state = camera.get_world().direct_space_state
	var selection = space_state.intersect_ray(ray_from, ray_to)
	return _map_selection(selection)

func _map_selection(selection):
	if selection.empty():
		return
	if selection["collider"] is GridMap:
		var gridmap = selection["collider"]
		var pos = gridmap.world_to_map(selection.position)
		var item = gridmap.get_cell_item(pos.x, pos.y, pos.z)
		var type_name = str(gridmap.mesh_library.get_item_name(item))
		print("item?: " + str(gridmap.mesh_library.get_item_name(item)))

		return {
			"selection": selection,
			"gridMap": gridmap,
			"cell_pos": pos,
			"cell_name": type_name
		}

	return {"selection": selection}
```



## Step 5. Saving/Loading (保存と読み込み)


## Step 6. It's alice! Alive! (モンスターとターン制)


## Step 7. Interaction (戦闘システム)


## Step 8. Data files (データファイル)


## Step 9. Items (アイテム)

### インベントリの実装

Inventory System
https://godotengine.org/asset-library/asset/1650


## Step 10. Magic (アイテム効果と特殊攻撃)


## Step 11. Simple game (テストプレイ)


## Step 12. Levels (階の生成と移動)


## Step 13. Experience (成長とスキル)


## Step 14. Citizens (店・クエスト・それ以外)


## Step 15. Free at last (あとは自由だ！)
